@model Shared.Models.InmuebleDto

@{
    Layout = null;
    ViewData["Title"] = "Editar Inmueble";
    @Html.Partial("_NavAdmin")
}

<link rel="stylesheet" href="@Url.Content("~/css/MantInmueble.css")" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<h2 class="text-center">ACTUALIZAR INMUEBLE CON ID @Model.IdInmueble</h2>

<div class="container mt-4">
    <div class="form-horizontal">
        <h4 class="text-center">Modificar información registrada</h4>
        <hr />

        <form asp-action="Edit" method="post" enctype="multipart/form-data" id="form-actualizar">
            @Html.HiddenFor(m => m.IdInmueble)
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label class="control-label">Nombre</label>
                    <input asp-for="Nombre" class="form-control" placeholder="Nombre del inmueble" required />
                    <span asp-validation-for="Nombre" class="text-danger"></span>
                </div>

                <div class="form-group col-md-6">
                    <label class="control-label">Capacidad</label>
                    <input asp-for="Capacidad" type="number" class="form-control" placeholder="Capacidad del inmueble" required />
                    <span asp-validation-for="Capacidad" class="text-danger"></span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label class="control-label">Número de Habitaciones</label>
                    <input asp-for="NumeroHabitaciones" type="number" class="form-control" placeholder="Número de habitaciones" required />
                    <span asp-validation-for="NumeroHabitaciones" class="text-danger"></span>
                </div>

                <div class="form-group col-md-6">
                    <label class="control-label">Precio por Noche</label>
                    <input asp-for="PrecioPorNoche" type="number" step="0.01" class="form-control" placeholder="Precio por noche" required />
                    <span asp-validation-for="PrecioPorNoche" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label">Descripción</label>
                <textarea asp-for="Descripcion" class="form-control1" rows="3" placeholder="Descripción del inmueble"></textarea>
                <span asp-validation-for="Descripcion" class="text-danger"></span>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label class="control-label">Servicios Incluidos</label>
                    <input asp-for="ServiciosIncluidos" class="form-control" placeholder="Servicios incluidos" />
                    <span asp-validation-for="ServiciosIncluidos" class="text-danger"></span>
                </div>

                <div class="form-group col-md-6">
                    <label class="control-label">Disponibilidad</label>
                    <select asp-for="Disponibilidad" class="form-control" required>
                        <option value="Si">Si</option>
                        <option value="No">No</option>
                    </select>
                    <span asp-validation-for="Disponibilidad" class="text-danger"></span>
                </div>
            </div>

            <input type="hidden" asp-for="ID_Admin_Creador" />

            <div class="form-group col-md-12 text-center">
                <label><strong>Imagen Habitación</strong></label>
                @if (!string.IsNullOrEmpty(Model.ImagenHabitacion))
                {
                    <div>
                        <img src="@Model.ImagenHabitacion?ts=@DateTime.Now.Ticks alt=" +Imagen actual" class="img-fluid mb-3 mt-2" style="max-height:400px; border-radius:10px;"/>
                        <p>
                            <strong>Archivo actual:</strong>
                            <span id="nombre-actual">@System.IO.Path.GetFileName(Model.ImagenHabitacion)</span>
                        </p>
                    </div>
                }
                <div style="display: flex; justify-content: center; align-items: center; height: 100px;">
                    <input type="file" name="imagen" class="form-control" id="input-imagen" onchange="mostrarNombreArchivo(event)">

                </div>
                <p id="nombre-nuevo" style="margin-top: 5px; color: green;"></p>
            </div>
            <input type="hidden" asp-for="Latitud" id="latitud" />
            <input type="hidden" asp-for="Longitud" id="longitud" />

            @if (Model.Latitud != null && Model.Longitud != null)
            {
                <div class="text-center">
                    <label><strong>Ubicación en el Mapa</strong></label>
                    <div class="map-wrapper">
                        <div id="map" style="height: 400px;"></div>
                    </div>
                </div>
            }
            else
            {
                <p><em>Este inmueble no tiene ubicación registrada</em></p>
            }

            <br>
            <div class="button-group-container mt-4 text-center">
                <button type="button" class="btn btn-dark" style="margin-right: 17px;" onclick="confirmarActualizacion()">Guardar</button>
                <a class="btn btn-secondary" asp-action="Index">Volver</a>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function mostrarNombreArchivo(event) {
        const input = event.target;
        const nombreArchivo = input.files[0]?.name;
        const spanNombreActual = document.getElementById('nombre-actual');
        const pNombreNuevo = document.getElementById('nombre-nuevo');

        if (nombreArchivo) {
            pNombreNuevo.textContent = "Nuevo archivo seleccionado: " + nombreArchivo;
            if (spanNombreActual) spanNombreActual.style.textDecoration = "line-through";
        } else {
            pNombreNuevo.textContent = "";
            if (spanNombreActual) spanNombreActual.style.textDecoration = "none";
        }
    }

    function confirmarActualizacion() {
        Swal.fire({
            title: '¿Estás seguro de actualizar el inmueble?',
            text: "Esta acción será permanente",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, actualizar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.getElementById('form-actualizar');
                fetch(form.action, {
                    method: form.method,
                    body: new FormData(form)
                }).then(res => {
                    if (res.ok) {
                    Swal.fire({
                        title: "¡Inmueble actualizado!",
                        text: "Datos guardados correctamente.",
                        icon: "success",
                        confirmButtonText: "Aceptar"
                    }).then(() => {
                        window.location.href = "/Inmueble/Index";
                    });
                    } else {
                        Swal.fire("Error de Actualización", "No se pudo actualizar el inmueble.", "error");
                    }
                });
            }
        });
        return false;
    }
</script>

@if (Model.Latitud != null && Model.Longitud != null)
{
    <script>
        const lat = @Model.Latitud;
        const lng = @Model.Longitud;
        const nombre = "@Model.Nombre";

        function initMap() {
            const ubicacion = { lat: lat, lng: lng };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: ubicacion
            });

            const marker = new google.maps.Marker({
                position: ubicacion,
                map: map,
                draggable: true,
                title: nombre
            });

            marker.addListener("dragend", function (event) {
                document.getElementById("latitud").value = event.latLng.lat();
                document.getElementById("longitud").value = event.latLng.lng();
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc1pV5K0s9Z7xGUUU03n6zBhKemKLiRx8&callback=initMap" async defer></script>
}